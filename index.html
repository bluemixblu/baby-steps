<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº·è??å°?ä¸????å­?ç­????å­¸ç?? V17.0 (??°ç??æ¨?æº?)</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "DFKai-SB", "KaiTi", serif; background-color: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        #debug-console { position: fixed; bottom: 0; right: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 9999; pointer-events: none; border-top: 2px solid #0f0; }
        .menu-toggle-btn { position: absolute; top: 15px; left: 15px; z-index: 100; background: #2c3e50; color: white; border: none; border-radius: 5px; padding: 10px 15px; font-size: 20px; cursor: pointer; display: none; }
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; overflow-y: auto; z-index: 90; transition: 0.3s; }
        .sidebar-title { padding: 20px; font-size: 22px; font-weight: bold; background: #1a252f; text-align: center; padding-top: 60px; flex-shrink: 0; border-bottom: 1px solid #34495e;}
        @media(min-width: 769px) { .sidebar-title { padding-top: 20px; } }
        .lesson-header { width: 100%; padding: 15px 20px; border: none; background: none; color: #ecf0f1; text-align: left; font-size: 18px; cursor: pointer; border-bottom: 1px solid #34495e; }
        .word-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: #233140; }
        .word-grid.show { display: grid; }
        .sidebar-word-btn { background: #34495e; color: #fff; border: 1px solid #4a6278; border-radius: 5px; padding: 8px 0; cursor: pointer; }
        .sidebar-word-btn.current { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f39c12; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 80; display: none; }
        .overlay.active { display: block; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding-bottom: 130px; }
        .current-lesson-info { position: absolute; top: 20px; font-size: 24px; color: #555; font-weight: bold; background: rgba(244,247,246,0.9); padding: 5px 20px; border-radius: 20px; z-index: 10; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; background: rgba(255,255,255,0.8); border: 2px solid #ddd; border-radius: 50%; font-size: 30px; color: #555; cursor: pointer; z-index: 15; }
        .prev-btn { left: 20px; } .next-btn { right: 20px; }
        .card-container { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; max-width: 95%; min-height: 400px; }
        .character-wrapper { display: flex; margin-bottom: 15px; gap: 10px; }
        #character-target-div { border: 3px solid #333; background: #fffadd; border-radius: 8px; position: relative; }
        #character-target-div::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #d47e7e; pointer-events: none; }
        #character-target-div::after { content: ""; position: absolute; left: 50%; top: 0; height: 100%; width: 1px; background: #d47e7e; pointer-events: none; }
        .zhuyin-system { display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: #333; }
        .zhuyin-light-tone { font-size: 30px; height: 30px; line-height: 30px; margin-bottom: -5px; visibility: hidden; }
        .zhuyin-symbols { font-size: 40px; writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 10px; }
        .zhuyin-side-tone { font-size: 35px; width: 25px; display: flex; justify-content: center; }
        .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 10px 20px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .btn-speak { background: #FFB74D; color: white; } .btn-animate { background: #4FC3F7; color: white; } .btn-quiz { background: #66BB6A; color: white; }
        .error-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-weight: bold; font-size: 20px; background: rgba(255,255,255,0.9); padding: 10px; display: none; text-align: center;}
        @media (max-width: 768px) { .menu-toggle-btn { display: block; } .sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .nav-btn { display: none; } .current-lesson-info { font-size: 18px; top: 15px; width: 60%; } .btn { padding: 8px 15px; font-size: 16px; } }
    </style>
</head>
<body>
    <div id="debug-console">V17.0 åº·è??å°?ä¸???????å§????ä¸?...<br></div>
    <button class="menu-toggle-btn" id="menu-toggle">? èª²ç????¸å??</button>
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar"><div class="sidebar-title">åº·è??å°?ä¸????å­?å­¸ç??</div></div>
    <div class="main-content" id="main-area">
        <div class="current-lesson-info" id="lesson-title"></div>
        <button class="nav-btn prev-btn" id="btn-prev">?</button>
        <button class="nav-btn next-btn" id="btn-next">?</button>
        <div class="card-container">
            <div class="character-wrapper">
                <div id="character-target-div"><div id="error-msg" class="error-message">??¾ä????? å­?æª?è³????</div></div>
                <div class="zhuyin-system" id="zhuyin-box">
                    <div class="zhuyin-light-tone" id="tone-light">??</div>
                    <div class="zhuyin-body-row"><div class="zhuyin-symbols" id="zhuyin-symbols"></div><div class="zhuyin-side-tone" id="tone-side"></div></div>
                </div>
            </div>
            <div class="controls">
                <button id="speak-button" class="btn btn-speak">? ??¸å?ºå??å­?</button>
                <button id="animate-button" class="btn btn-animate">?? ç­??????????</button>
                <button id="quiz-button" class="btn btn-quiz">?? ç·´ç????¸å¯«</button>
            </div>
            <div class="progress-indicator" id="progress-text"></div>
        </div>
    </div>

    <script>
        function debugLog(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(`[DEBUG] ${msg}`);
        }

        // åº·è??å°?ä¸?èª²ç??
        const lessons = [
            { title: "ç¬¬ä??èª? ?????????", words: [{char: "???", zhuyin: "??????"}, {char: "???", zhuyin: "?????¡Ë?"}, {char: "å·?", zhuyin: "?????¨ã????"}, {char: "???", zhuyin: "??§ã?¡Ë?"}, {char: "ä½?", zhuyin: "?????§Ë?"}, {char: "ä»?", zhuyin: "??????"}, {char: "ä¹?", zhuyin: "??§ã????"}, {char: "ä¸?", zhuyin: "?????¤Ë?"}, {char: "ä¸?", zhuyin: "?????§ã????"}] },
            { title: "ç¬¬ä??èª? ?????¯èª°????", words: [{char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "?????"}, {char: "èª?", zhuyin: "????????"}, {char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "??¨ã????"}, {char: "???", zhuyin: "??????"}, {char: "å¥?", zhuyin: "????????"}, {char: "äº?", zhuyin: "????????"}, {char: "???", zhuyin: "?????"}, {char: "å¤?", zhuyin: "?????¨ã??"}, {char: "???", zhuyin: "????????"}] },
            { title: "ç¬¬ä??èª? ç§????", words: [{char: "ç§?", zhuyin: "?????§ã??"}, {char: "???", zhuyin: "?????§ã??"}, {char: "???", zhuyin: "?????¢Ë?"}, {char: "???", zhuyin: "??¨ã?¢Ë?"}, {char: "???", zhuyin: "????????"}, {char: "é«?", zhuyin: "??????"}, {char: "å±?", zhuyin: "??????"}, {char: "???", zhuyin: "????????"}, {char: "å¤?", zhuyin: "????????"}, {char: "æµ?", zhuyin: "????????"}, {char: "???", zhuyin: "?????¥Ë?"}, {char: "???", zhuyin: "??§ã?¡Ë?"}, {char: "???", zhuyin: "????????"}, {char: "èµ?", zhuyin: "?????§Ë?"}] },
            { title: "ç¬¬å??èª? å¤§å??å­?ï¼?å°????å­?", words: [{char: "å­?", zhuyin: "?????"}, {char: "å°?", zhuyin: "?????§ã????"}, {char: "èª?", zhuyin: "????????"}, {char: "???", zhuyin: "?????§ã?¤Ë?"}, {char: "äº?", zhuyin: "????????"}, {char: "???", zhuyin: "??????"}, {char: "???", zhuyin: "?????¢Ë?"}, {char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "???"}, {char: "???", zhuyin: "?????§ã??"}, {char: "???", zhuyin: "??¨ã??"}, {char: "???", zhuyin: "??????"}, {char: "å¿?", zhuyin: "?????§ã??"}] },
            { title: "ç¬¬ä??èª? æ¯?ä¸?æ¯?", words: [{char: "æ¯?", zhuyin: "?????§Ë?"}, {char: "???", zhuyin: "????????"}, {char: "è£?", zhuyin: "?????§Ë?"}, {char: "å¤?", zhuyin: "??¨ã????"}, {char: "???", zhuyin: "??§ã?¡Ë?"}, {char: "ä»?", zhuyin: "????????"}, {char: "éº?", zhuyin: "????????"}, {char: "ä¸?", zhuyin: "?????¨Ë?"}, {char: "???", zhuyin: "?????¨ã?¥Ë?"}, {char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "??¨ã?¢Ë?"}, {char: "???", zhuyin: "??¨ã?¤Ë?"}, {char: "ä¸?", zhuyin: "?????¨Ë?"}, {char: "???", zhuyin: "??§ã?¡Ë?"}] },
            { title: "ç¬¬å?­èª² å°?è·?", words: [{char: "è·?", zhuyin: "?????¨Ë?"}, {char: "???", zhuyin: "?????¤Ë?"}, {char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "?????¨ã??"}, {char: "ç´?", zhuyin: "?????¨ã?¥Ë?"}, {char: "èµ?", zhuyin: "?????¡Ë?"}, {char: "???", zhuyin: "????????"}, {char: "???", zhuyin: "?????§ã?¤Ë?"}, {char: "èª?", zhuyin: "?????¨ã??"}, {char: "???", zhuyin: "?????¨ã????"}, {char: "å¾?", zhuyin: "?????¨ã?¥Ë?"}, {char: "???", zhuyin: "?????¡Ë?"}, {char: "???", zhuyin: "????????"}] }
        ];

        let currentLessonIdx = 0;
        let currentWordIdx = 0;
        let writer = null;

        function getResponsiveSize() {
            const width = window.innerWidth;
            return width < 400 ? 260 : width < 600 ? 280 : 320;
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '<div class="sidebar-title">åº·è??å°?ä¸????å­?å­¸ç??</div>';
            lessons.forEach((lesson, lIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'lesson-group';
                const headerBtn = document.createElement('button');
                headerBtn.className = 'lesson-header';
                headerBtn.innerText = lesson.title;
                headerBtn.onclick = () => { changeLesson(lIndex, 0); };
                const gridDiv = document.createElement('div');
                gridDiv.className = 'word-grid';
                gridDiv.id = `grid-${lIndex}`;
                lesson.words.forEach((wordObj, wIndex) => {
                    const wordBtn = document.createElement('button');
                    wordBtn.className = 'sidebar-word-btn';
                    wordBtn.innerText = wordObj.char;
                    wordBtn.id = `btn-${lIndex}-${wIndex}`;
                    wordBtn.onclick = (e) => { e.stopPropagation(); changeLesson(lIndex, wIndex); toggleMenu(); };
                    gridDiv.appendChild(wordBtn);
                });
                groupDiv.appendChild(headerBtn);
                groupDiv.appendChild(gridDiv);
                sidebar.appendChild(groupDiv);
            });
        }

        function changeLesson(lIndex, wIndex) {
            currentLessonIdx = lIndex;
            currentWordIdx = wIndex;
            updateSidebarUI();
            document.getElementById('lesson-title').innerText = lessons[lIndex].title;
            loadCharacter();
        }

        function updateSidebarUI() {
            document.querySelectorAll('.lesson-header').forEach((btn, idx) => idx === currentLessonIdx ? btn.classList.add('active') : btn.classList.remove('active'));
            document.querySelectorAll('.word-grid').forEach((grid, idx) => idx === currentLessonIdx ? grid.classList.add('show') : grid.classList.remove('show'));
            document.querySelectorAll('.sidebar-word-btn').forEach(btn => btn.classList.remove('current'));
            const activeBtn = document.getElementById(`btn-${currentLessonIdx}-${currentWordIdx}`);
            if(activeBtn) activeBtn.classList.add('current');
        }

        function loadCharacter() {
            const lesson = lessons[currentLessonIdx];
            const word = lesson.words[currentWordIdx];
            document.getElementById('progress-text').innerText = `${currentWordIdx + 1} / ${lesson.words.length}`;
            const boxSize = getResponsiveSize();
            document.getElementById('zhuyin-box').style.height = boxSize + 'px';
            document.getElementById('character-target-div').innerHTML = '<div id="error-msg" class="error-message">??¾ä????? å­?æª?è³????</div>';
            document.getElementById('error-msg').style.display = 'none';

            debugLog(`------------------`);
            debugLog(`???å§?è¼???¥å??å­?: [${word.char}]`);
            
            writer = HanziWriter.create('character-target-div', word.char, {
                width: boxSize, height: boxSize, padding: boxSize * 0.08,
                strokeColor: '#333333', radicalColor: '#e91e63',
                showOutline: true, outlineColor: '#ddd',
                strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                highlightOnVariation: true, drawingWidth: boxSize * 0.1,
                leniency: 2.0, // «D±`¼eÃPªº®Ñ¼g§P©w¡A¾A¦X¤pªB¤Í½m²ß
                
                // V17.0 ??ªå??ä½¿ç?¨æ?¬å?°å?°ç??æ¨?æº?å­?æª?
                charDataLoader: function(char, onComplete) {
                    // 1. ??ªå??è¼???¥æ?¬å?? data/ è³????å¤¾ï????°ç??æ¨?æº????ï¼?
                    const localUrl = './data/' + char + '.json';
                    
                    debugLog(`1. ???è©¦æ?¬å?°è?????: ${localUrl}`);
                    fetch(localUrl)
                    .then(res => {
                        if (!res.ok) throw new Error("Local 404");
                        return res.json();
                    })
                    .then(data => {
                        debugLog(`? ??????ï¼?ä½¿ç?¨æ?¬å?°å?°ç??æ¨?æº?å­?æª?`);
                        onComplete(data);
                    })
                    .catch(err => {
                        // 2. ??¬å?°æ?¾ä????°ï?????è©¦å?? CDN è¼???¥ï??ç¹?é«?å­?åº«ï??
                        debugLog(`??¬å?°æ?¾ä????°å??æª?ï¼????è©¦å?? CDN è¼????...`);
                        // ??????è©¦ç??é«?å­?åº?
                        const cdnUrlTraditional = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + encodeURIComponent(char) + '.json';
                        fetch(cdnUrlTraditional)
                        .then(res => {
                            if (!res.ok) throw new Error("Traditional not found");
                            return res.json();
                        })
                        .then(data => {
                            debugLog(`? ??????å¾? CDN è¼???¥ï??ç¹?é«?å­?åº«ï??`);
                            onComplete(data);
                        })
                        .catch(err2 => {
                            // ???å¾?????????°é????¨å??åº?
                            debugLog(`ç¹?é«?å­?åº«ä????¾ä????°ï??ä½¿ç?¨é????¨å??åº?...`);
                            const cdnUrlFallback = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@latest/' + encodeURIComponent(char) + '.json';
                            fetch(cdnUrlFallback)
                            .then(res => res.json())
                            .then(data => {
                                debugLog(`? ??????å¾??????¨å??åº«è????¥ï????¯è?½é????°ç??æ¨?æº?ï¼?`);
                                onComplete(data);
                            })
                            .catch(err3 => {
                                debugLog(`? å®???¨æ?¾ä????°å??æª?`);
                                document.getElementById('error-msg').style.display = 'block';
                                onComplete(null);
                            });
                        });
                    });
                }
            });

            renderZhuyinLayout(word.zhuyin);
            updateSidebarUI();
        }

        function renderZhuyinLayout(zhuyinStr) {
            const lightToneDiv = document.getElementById('tone-light');
            const symbolsDiv = document.getElementById('zhuyin-symbols');
            const sideToneDiv = document.getElementById('tone-side');
            lightToneDiv.style.visibility = 'hidden';
            sideToneDiv.style.visibility = 'hidden';
            sideToneDiv.innerHTML = '';
            let symbols = '';
            if (zhuyinStr.includes('??')) {
                lightToneDiv.style.visibility = 'visible';
                symbols = zhuyinStr.replace('??', '');
            } else {
                const lastChar = zhuyinStr.slice(-1);
                if (['??', '??', '??'].includes(lastChar)) {
                    sideToneDiv.innerHTML = lastChar;
                    sideToneDiv.style.visibility = 'visible';
                    symbols = zhuyinStr.slice(0, -1);
                } else {
                    symbols = zhuyinStr;
                }
            }
            symbolsDiv.innerHTML = symbols;
        }

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        document.getElementById('menu-toggle').onclick = toggleMenu;
        document.getElementById('overlay').onclick = toggleMenu;

        function speakWord() {
            if ('speechSynthesis' in window) {
                const word = lessons[currentLessonIdx].words[currentWordIdx].char;
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'zh-TW'; utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        document.getElementById('btn-prev').onclick = () => { if(currentWordIdx > 0) changeLesson(currentLessonIdx, currentWordIdx - 1); };
        document.getElementById('btn-next').onclick = () => { 
            if(currentWordIdx < lessons[currentLessonIdx].words.length - 1) changeLesson(currentLessonIdx, currentWordIdx + 1);
            else if(currentLessonIdx < lessons.length - 1 && confirm("???å¾?ä¸?ä¸?èª²å??ï¼?")) changeLesson(currentLessonIdx + 1, 0);
        };
        document.getElementById('speak-button').onclick = speakWord;
        document.getElementById('animate-button').onclick = () => { speakWord(); writer.cancelQuiz(); writer.animateCharacter(); };
        document.getElementById('quiz-button').onclick = () => { writer.quiz({ onComplete: () => { speakWord(); setTimeout(() => alert('å¤ªæ??äº?ï¼?å¯«å?????å¥½ï??'), 300); }}); };

        window.addEventListener('resize', () => { clearTimeout(window.resizeTimer); window.resizeTimer = setTimeout(loadCharacter, 200); });
        window.onload = function() { renderSidebar(); changeLesson(0, 0); debugLog('åº·è??å°?ä¸????è¼???¥å?????ï¼?'); };
    </script>
</body>
</html>
