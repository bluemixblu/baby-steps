<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- ç·©å­˜æ§åˆ¶ï¼šç¢ºä¿ç”¨æˆ¶ç²å–æœ€æ–°ç‰ˆæœ¬ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- ç‰ˆæœ¬è™Ÿï¼šV18.0 - 2025-11-28 -->
    <title>åº·è»’å°ä¸€åœ‹å­—ç­†é †ç·´ç¿’ V18.0</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "DFKai-SB", "KaiTi", serif; background-color: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; user-select: none; }
        #debug-console { position: fixed; bottom: 0; right: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 9999; pointer-events: none; border-top: 2px solid #0f0; display: none; }
        .menu-toggle-btn { position: absolute; top: 15px; left: 15px; z-index: 100; background: #2c3e50; color: white; border: none; border-radius: 5px; padding: 10px 15px; font-size: 20px; cursor: pointer; display: none; }
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; overflow-y: auto; z-index: 90; transition: 0.3s; }
        .sidebar-title { padding: 20px; font-size: 22px; font-weight: bold; background: #1a252f; text-align: center; padding-top: 60px; flex-shrink: 0; border-bottom: 1px solid #34495e;}
        @media(min-width: 769px) { .sidebar-title { padding-top: 20px; } }
        .lesson-header { width: 100%; padding: 15px 20px; border: none; background: none; color: #ecf0f1; text-align: left; font-size: 18px; cursor: pointer; border-bottom: 1px solid #34495e; }
        .word-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: #233140; }
        .word-grid.show { display: grid; }
        .sidebar-word-btn { background: #34495e; color: #fff; border: 1px solid #4a6278; border-radius: 5px; padding: 8px 0; cursor: pointer; }
        .sidebar-word-btn.current { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f39c12; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 80; display: none; }
        .overlay.active { display: block; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding-bottom: 130px; }
        .current-lesson-info { position: absolute; top: 20px; font-size: 24px; color: #555; font-weight: bold; background: rgba(244,247,246,0.9); padding: 5px 20px; border-radius: 20px; z-index: 10; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; background: rgba(255,255,255,0.8); border: 2px solid #ddd; border-radius: 50%; font-size: 30px; color: #555; cursor: pointer; z-index: 15; }
        .prev-btn { left: 20px; } .next-btn { right: 20px; }
        .card-container { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; max-width: 95%; min-height: 400px; }
        .character-wrapper { display: flex; margin-bottom: 15px; gap: 10px; }
        #character-target-div { border: 3px solid #333; background: #fffadd; border-radius: 8px; position: relative; }
        #character-target-div::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #d47e7e; pointer-events: none; }
        #character-target-div::after { content: ""; position: absolute; left: 50%; top: 0; height: 100%; width: 1px; background: #d47e7e; pointer-events: none; }
        .zhuyin-system { display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: #333; }
        .zhuyin-light-tone { font-size: 48px; height: 50px; line-height: 50px; visibility: hidden; text-align: center; }
        .zhuyin-body-row { display: flex; flex-direction: row; align-items: center; }
        .zhuyin-symbols { font-size: 40px; writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 8px; }
        .zhuyin-side-tone { font-size: 56px; display: flex; align-items: center; justify-content: center; margin-left: 3px; }
        .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 10px 20px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .btn-speak { background: #FFB74D; color: white; }
        .btn-animate { background: #4FC3F7; color: white; }
        .btn-quiz { background: #66BB6A; color: white; }
        .btn-test { background: linear-gradient(135deg, #9C27B0, #E91E63); color: white; }
        .error-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-weight: bold; font-size: 20px; background: rgba(255,255,255,0.9); padding: 10px; display: none; text-align: center;}
        @media (max-width: 768px) { .menu-toggle-btn { display: block; } .sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .nav-btn { display: none; } .current-lesson-info { font-size: 18px; top: 15px; width: 60%; } .btn { padding: 8px 15px; font-size: 16px; } }
        
        /* Quiz Mode Styles */
        .quiz-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .quiz-modal.active { display: flex; }
        .quiz-setup-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 40px; border-radius: 20px; text-align: center; color: white; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
        .quiz-setup-box h2 { margin: 0 0 25px 0; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .quiz-setup-box label { display: block; margin-bottom: 8px; font-size: 18px; }
        .quiz-input-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .quiz-input { width: 60px; padding: 12px; font-size: 24px; text-align: center; border: none; border-radius: 10px; background: rgba(255,255,255,0.9); color: #333; font-weight: bold; }
        .quiz-input:focus { outline: 3px solid #f1c40f; }
        .quiz-separator { font-size: 28px; font-weight: bold; }
        .quiz-btn-row { display: flex; gap: 15px; justify-content: center; }
        .quiz-start-btn { background: #f1c40f; color: #333; border: none; padding: 15px 40px; font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .quiz-start-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(241,196,15,0.5); }
        .quiz-cancel-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; }
        .quiz-cancel-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Quiz Game Mode */
        .quiz-game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 1001; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .quiz-game-container.active { display: flex; }
        .quiz-header { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-sizing: border-box; }
        .quiz-progress { color: #f1c40f; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .quiz-exit-btn { background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; font-size: 16px; border-radius: 25px; cursor: pointer; }
        .quiz-exit-btn:hover { background: rgba(255,255,255,0.2); }
        .quiz-card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; align-items: center; }
        .quiz-zhuyin-display { margin-bottom: 20px; }
        .quiz-zhuyin-large { font-size: 60px; writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 10px; color: #333; font-weight: bold; }
        .quiz-tone-light { font-size: 40px; text-align: center; margin-bottom: 5px; }
        .quiz-tone-side { font-size: 48px; margin-left: 5px; }
        #quiz-writer-div { border: 4px solid #333; background: linear-gradient(135deg, #fffadd, #fff5cc); border-radius: 12px; position: relative; }
        #quiz-writer-div::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(212,126,126,0.5); pointer-events: none; }
        #quiz-writer-div::after { content: ""; position: absolute; left: 50%; top: 0; height: 100%; width: 2px; background: rgba(212,126,126,0.5); pointer-events: none; }
        .quiz-hint-text { margin-top: 15px; color: #888; font-size: 16px; }
        
        /* Success Animation */
        .quiz-success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1002; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .quiz-success-overlay.active { display: flex; }
        .success-emoji { font-size: 120px; animation: bounce 0.6s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        .success-text { color: #f1c40f; font-size: 48px; font-weight: bold; margin-top: 20px; text-shadow: 3px 3px 6px rgba(0,0,0,0.5); }
        .success-subtext { color: white; font-size: 24px; margin-top: 10px; }
        .success-btn { margin-top: 30px; background: #f1c40f; color: #333; border: none; padding: 15px 50px; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="debug-console">V18.0 åº·è»’å°ä¸€åœ‹å­—ç³»çµ±è¼‰å…¥ä¸­...<br></div>
    <button class="menu-toggle-btn" id="menu-toggle">â˜° é¸æ“‡èª²ç¨‹</button>
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar"><div class="sidebar-title">åº·è»’å°ä¸€åœ‹å­—ç­†é †ç·´ç¿’<div style="font-size:12px;opacity:0.7;margin-top:5px;">V18.0</div></div></div>
    <div class="main-content" id="main-area">
        <div class="current-lesson-info" id="lesson-title"></div>
        <button class="nav-btn prev-btn" id="btn-prev">â—€</button>
        <button class="nav-btn next-btn" id="btn-next">â–¶</button>
        <div class="card-container">
            <div class="character-wrapper">
                <div id="character-target-div"><div id="error-msg" class="error-message">è¼‰å…¥å¤±æ•— å­—åº«ç„¡è³‡æ–™</div></div>
                <div class="zhuyin-system" id="zhuyin-box">
                    <div class="zhuyin-light-tone" id="tone-light">Ë™</div>
                    <div class="zhuyin-body-row"><div class="zhuyin-symbols" id="zhuyin-symbols"></div><div class="zhuyin-side-tone" id="tone-side"></div></div>
                </div>
            </div>
            <div class="controls">
                <button id="speak-button" class="btn btn-speak">ğŸ”Š è½ç™¼éŸ³</button>
                <button id="animate-button" class="btn btn-animate">âœï¸ ç­†é †å‹•ç•«</button>
                <button id="quiz-button" class="btn btn-quiz">ğŸ“ ç·´ç¿’æ›¸å¯«</button>
                <button id="test-button" class="btn btn-test">ğŸ¯ å°æ¸¬é©—</button>
            </div>
            <div class="progress-indicator" id="progress-text"></div>
        </div>
    </div>

    <!-- Quiz Setup Modal -->
    <div class="quiz-modal" id="quiz-modal">
        <div class="quiz-setup-box">
            <h2>ğŸ¯ å°æ¸¬é©—</h2>
            <label>è«‹è¼¸å…¥èª²ç¨‹ç¯„åœ</label>
            <div class="quiz-input-row">
                <span>ç¬¬</span>
                <input type="number" id="quiz-start-lesson" class="quiz-input" value="1" min="1" max="6">
                <span class="quiz-separator">~</span>
                <input type="number" id="quiz-end-lesson" class="quiz-input" value="3" min="1" max="6">
                <span>èª²</span>
            </div>
            <div class="quiz-btn-row">
                <button class="quiz-cancel-btn" id="quiz-cancel-btn">å–æ¶ˆ</button>
                <button class="quiz-start-btn" id="quiz-start-btn">é–‹å§‹æ¸¬é©— ğŸš€</button>
            </div>
        </div>
    </div>

    <!-- Quiz Game Container -->
    <div class="quiz-game-container" id="quiz-game-container">
        <div class="quiz-header">
            <div class="quiz-progress" id="quiz-game-progress">1 / 5</div>
            <button class="quiz-exit-btn" id="quiz-exit-btn">âœ– çµæŸæ¸¬é©—</button>
        </div>
        <div class="quiz-card">
            <div class="quiz-zhuyin-display">
                <div class="quiz-tone-light" id="quiz-tone-light"></div>
                <div style="display: flex; align-items: center;">
                    <div class="quiz-zhuyin-large" id="quiz-zhuyin-symbols"></div>
                    <div class="quiz-tone-side" id="quiz-tone-side"></div>
                </div>
            </div>
            <div id="quiz-writer-div"></div>
            <div class="quiz-hint-text">è«‹å¯«å‡ºé€™å€‹æ³¨éŸ³å°æ‡‰çš„åœ‹å­—</div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="quiz-success-overlay" id="quiz-success-overlay">
        <div class="success-emoji">ğŸ‰</div>
        <div class="success-text">æ­å–œéé—œï¼</div>
        <div class="success-subtext" id="success-subtext">å…¨éƒ¨ 5 é¡Œéƒ½ç­”å°äº†ï¼</div>
        <button class="success-btn" id="success-close-btn">å¤ªæ£’äº†ï¼ ğŸ‘</button>
    </div>

    <script>
        function debugLog(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += '<div>[' + new Date().toLocaleTimeString() + '] ' + msg + '</div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log('[DEBUG] ' + msg);
        }

        // åº·è»’å°ä¸€èª²ç¨‹
        const lessons = [
            { title: "ç¬¬ä¸€èª² æ‹æ‹æ‰‹", words: [
                {char: "æ‹", zhuyin: "ã„†ã„"}, {char: "æ‰‹", zhuyin: "ã„•ã„¡Ë‡"}, 
                {char: "å·¦", zhuyin: "ã„—ã„¨ã„›Ë‡"}, {char: "å³", zhuyin: "ã„§ã„¡Ë‹"}, 
                {char: "ä½ ", zhuyin: "ã„‹ã„§Ë‡"}, {char: "ä»–", zhuyin: "ã„Šã„š"}, 
                {char: "ä¹Ÿ", zhuyin: "ã„§ã„Ë‡"}, {char: "ä¸Š", zhuyin: "ã„•ã„¤Ë‹"}, 
                {char: "ä¸‹", zhuyin: "ã„’ã„§ã„šË‹"}
            ]},
            { title: "ç¬¬äºŒèª² é€™æ˜¯èª°çš„?", words: [
                {char: "é€™", zhuyin: "ã„“ã„œË‹"}, {char: "æ˜¯", zhuyin: "ã„•Ë‹"}, 
                {char: "èª°", zhuyin: "ã„•ã„ŸËŠ"}, {char: "çš„", zhuyin: "Ë™ã„‰ã„œ"}, 
                {char: "æˆ‘", zhuyin: "ã„¨ã„›Ë‡"}, {char: "åˆ†", zhuyin: "ã„ˆã„£"}, 
                {char: "å¥½", zhuyin: "ã„ã„ Ë‡"}, {char: "äº†", zhuyin: "Ë™ã„Œã„œ"}, 
                {char: "å•Š", zhuyin: "Ë™ã„š"}, {char: "å¤š", zhuyin: "ã„‰ã„¨ã„›"}, 
                {char: "å€‹", zhuyin: "Ë™ã„ã„œ"}
            ]},
            { title: "ç¬¬ä¸‰èª² ç§‹åƒ", words: [
                {char: "ç§‹", zhuyin: "ã„‘ã„§ã„¡"}, {char: "åƒ", zhuyin: "ã„‘ã„§ã„¢"}, 
                {char: "å’Œ", zhuyin: "ã„ã„¢Ë‹"}, {char: "ç©", zhuyin: "ã„¨ã„¢ËŠ"}, 
                {char: "é™ª", zhuyin: "ã„†ã„ŸËŠ"}, {char: "é«˜", zhuyin: "ã„ã„ "}, 
                {char: "å±±", zhuyin: "ã„•ã„¢"}, {char: "åˆ°", zhuyin: "ã„‰ã„ Ë‹"}, 
                {char: "å¤§", zhuyin: "ã„‰ã„šË‹"}, {char: "æµ·", zhuyin: "ã„ã„Ë‡"}, 
                {char: "æœ‹", zhuyin: "ã„†ã„¥ËŠ"}, {char: "å‹", zhuyin: "ã„§ã„¡Ë‡"}, 
                {char: "å€‘", zhuyin: "Ë™ã„‡ã„£"}, {char: "èµ·", zhuyin: "ã„‘ã„§Ë‡"}
            ]},
            { title: "ç¬¬å››èª² å¤§å€‹å­ï¼Œå°å€‹å­", words: [
                {char: "å­", zhuyin: "Ë™ã„—"}, {char: "å°", zhuyin: "ã„’ã„§ã„ Ë‡"}, 
                {char: "èª²", zhuyin: "ã„ã„œË‹"}, {char: "å…©", zhuyin: "ã„Œã„§ã„¤Ë‡"}, 
                {char: "äºº", zhuyin: "ã„–ã„£ËŠ"}, {char: "æ‹‰", zhuyin: "ã„Œã„š"}, 
                {char: "çœ‹", zhuyin: "ã„ã„¢Ë‹"}, {char: "æ‰¾", zhuyin: "ã„“ã„ Ë‡"}, 
                {char: "éš»", zhuyin: "ã„“"}, {char: "é’", zhuyin: "ã„‘ã„§ã„¥"}, 
                {char: "è›™", zhuyin: "ã„¨ã„š"}, {char: "é–‹", zhuyin: "ã„ã„"}, 
                {char: "å¿ƒ", zhuyin: "ã„’ã„§ã„£"}
            ]},
            { title: "ç¬¬äº”èª² æ¯”ä¸€æ¯”", words: [
                {char: "æ¯”", zhuyin: "ã„…ã„§Ë‡"}, {char: "é–€", zhuyin: "ã„‡ã„£ËŠ"}, 
                {char: "è£¡", zhuyin: "ã„Œã„§Ë‡"}, {char: "å¤–", zhuyin: "ã„¨ã„Ë‹"}, 
                {char: "æœ‰", zhuyin: "ã„§ã„¡Ë‡"}, {char: "ä»€", zhuyin: "ã„•ã„œËŠ"}, 
                {char: "éº¼", zhuyin: "Ë™ã„‡ã„œ"}, {char: "ä¸", zhuyin: "ã„…ã„¨Ë‹"}, 
                {char: "åŒ", zhuyin: "ã„Šã„¨ã„¥ËŠ"}, {char: "æ—©", zhuyin: "ã„—ã„ Ë‡"}, 
                {char: "æ™š", zhuyin: "ã„¨ã„¢Ë‡"}, {char: "ç‹", zhuyin: "ã„¨ã„¤ËŠ"}, 
                {char: "ä¸»", zhuyin: "ã„“ã„¨Ë‡"}, {char: "åˆ", zhuyin: "ã„§ã„¡Ë‹"}
            ]},
            { title: "ç¬¬å…­èª² å°è·¯", words: [
                {char: "è·¯", zhuyin: "ã„Œã„¨Ë‹"}, {char: "é•·", zhuyin: "ã„”ã„¤ËŠ"}, 
                {char: "ç™½", zhuyin: "ã„…ã„ËŠ"}, {char: "èŠ±", zhuyin: "ã„ã„¨ã„š"}, 
                {char: "ç´…", zhuyin: "ã„ã„¨ã„¥ËŠ"}, {char: "èµ°", zhuyin: "ã„—ã„¡Ë‡"}, 
                {char: "åœ¨", zhuyin: "ã„—ã„Ë‹"}, {char: "å‘", zhuyin: "ã„’ã„§ã„¤Ë‹"}, 
                {char: "èªª", zhuyin: "ã„•ã„¨ã„›"}, {char: "æœµ", zhuyin: "ã„‰ã„¨ã„›Ë‡"}, 
                {char: "å¾", zhuyin: "ã„˜ã„¨ã„¥ËŠ"}, {char: "é ­", zhuyin: "ã„Šã„¡ËŠ"}, 
                {char: "é‚£", zhuyin: "ã„‹ã„šË‹"}
            ]}
        ];

        let currentLessonIdx = 0;
        let currentWordIdx = 0;
        let writer = null;

        function getResponsiveSize() {
            const width = window.innerWidth;
            return width < 400 ? 260 : width < 600 ? 280 : 320;
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '<div class="sidebar-title">åº·è»’å°ä¸€åœ‹å­—ç­†é †ç·´ç¿’</div>';
            lessons.forEach((lesson, lIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'lesson-group';
                const headerBtn = document.createElement('button');
                headerBtn.className = 'lesson-header';
                headerBtn.innerText = lesson.title;
                headerBtn.onclick = () => { changeLesson(lIndex, 0); };
                const gridDiv = document.createElement('div');
                gridDiv.className = 'word-grid';
                gridDiv.id = 'grid-' + lIndex;
                lesson.words.forEach((wordObj, wIndex) => {
                    const wordBtn = document.createElement('button');
                    wordBtn.className = 'sidebar-word-btn';
                    wordBtn.innerText = wordObj.char;
                    wordBtn.id = 'btn-' + lIndex + '-' + wIndex;
                    wordBtn.onclick = (e) => { e.stopPropagation(); changeLesson(lIndex, wIndex); toggleMenu(); };
                    gridDiv.appendChild(wordBtn);
                });
                groupDiv.appendChild(headerBtn);
                groupDiv.appendChild(gridDiv);
                sidebar.appendChild(groupDiv);
            });
        }

        function changeLesson(lIndex, wIndex) {
            currentLessonIdx = lIndex;
            currentWordIdx = wIndex;
            updateSidebarUI();
            document.getElementById('lesson-title').innerText = lessons[lIndex].title;
            loadCharacter();
        }

        function updateSidebarUI() {
            document.querySelectorAll('.lesson-header').forEach((btn, idx) => idx === currentLessonIdx ? btn.classList.add('active') : btn.classList.remove('active'));
            document.querySelectorAll('.word-grid').forEach((grid, idx) => idx === currentLessonIdx ? grid.classList.add('show') : grid.classList.remove('show'));
            document.querySelectorAll('.sidebar-word-btn').forEach(btn => btn.classList.remove('current'));
            const activeBtn = document.getElementById('btn-' + currentLessonIdx + '-' + currentWordIdx);
            if(activeBtn) activeBtn.classList.add('current');
        }

        function loadCharacter() {
            const lesson = lessons[currentLessonIdx];
            const word = lesson.words[currentWordIdx];
            document.getElementById('progress-text').innerText = (currentWordIdx + 1) + ' / ' + lesson.words.length;
            const boxSize = getResponsiveSize();
            document.getElementById('zhuyin-box').style.height = boxSize + 'px';
            document.getElementById('character-target-div').innerHTML = '<div id="error-msg" class="error-message">è¼‰å…¥å¤±æ•— å­—åº«ç„¡è³‡æ–™</div>';
            document.getElementById('error-msg').style.display = 'none';

            debugLog('------------------');
            debugLog('æ­£åœ¨è¼‰å…¥åœ‹å­—: [' + word.char + ']');
            
            writer = HanziWriter.create('character-target-div', word.char, {
                width: boxSize, height: boxSize, padding: boxSize * 0.08,
                strokeColor: '#333333', radicalColor: '#e91e63',
                showOutline: true, outlineColor: '#ddd',
                strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                highlightOnVariation: true, drawingWidth: boxSize * 0.1,
                leniency: 2.0,
                
                charDataLoader: function(char, onComplete) {
                    const localUrl = './data/' + char + '.json';
                    
                    debugLog('1. å˜—è©¦æœ¬åœ°æª”æ¡ˆ: ' + localUrl);
                    fetch(localUrl)
                    .then(res => {
                        if (!res.ok) throw new Error("Local 404");
                        return res.json();
                    })
                    .then(data => {
                        debugLog('âœ“ æˆåŠŸï¼ä½¿ç”¨æœ¬åœ°å°ç£æ¨™æº–å­—æª”');
                        onComplete(data);
                    })
                    .catch(err => {
                        debugLog('æœ¬åœ°æª”æ¡ˆä¸å­˜åœ¨ï¼Œå˜—è©¦ CDN ç¹é«”...');
                        const cdnUrlTraditional = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + encodeURIComponent(char) + '.json';
                        fetch(cdnUrlTraditional)
                        .then(res => {
                            if (!res.ok) throw new Error("Traditional not found");
                            return res.json();
                        })
                        .then(data => {
                            debugLog('âœ“ æˆåŠŸå¾ CDN ç¹é«”å­—åº«è¼‰å…¥ï¼');
                            onComplete(data);
                        })
                        .catch(err2 => {
                            debugLog('ç¹é«”å­—åº«ä¸å­˜åœ¨ï¼Œä½¿ç”¨é€šç”¨å­—åº«...');
                            const cdnUrlFallback = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@latest/' + encodeURIComponent(char) + '.json';
                            fetch(cdnUrlFallback)
                            .then(res => res.json())
                            .then(data => {
                                debugLog('âœ“ æˆåŠŸå¾é€šç”¨å­—åº«è¼‰å…¥ï¼ˆå¯èƒ½éå°ç£æ¨™æº–ï¼‰');
                                onComplete(data);
                            })
                            .catch(err3 => {
                                debugLog('âœ— æ‰€æœ‰ä¾†æºéƒ½ç„¡æ³•è¼‰å…¥');
                                document.getElementById('error-msg').style.display = 'block';
                                onComplete(null);
                            });
                        });
                    });
                }
            });

            renderZhuyinLayout(word.zhuyin);
            updateSidebarUI();
        }

        function renderZhuyinLayout(zhuyinStr) {
            const lightToneDiv = document.getElementById('tone-light');
            const symbolsDiv = document.getElementById('zhuyin-symbols');
            const sideToneDiv = document.getElementById('tone-side');
            lightToneDiv.style.visibility = 'hidden';
            sideToneDiv.style.visibility = 'hidden';
            sideToneDiv.innerHTML = '';
            let symbols = '';
            if (zhuyinStr.includes('Ë™')) {
                lightToneDiv.style.visibility = 'visible';
                symbols = zhuyinStr.replace('Ë™', '');
            } else {
                const lastChar = zhuyinStr.slice(-1);
                if (['ËŠ', 'Ë‡', 'Ë‹'].includes(lastChar)) {
                    sideToneDiv.innerHTML = lastChar;
                    sideToneDiv.style.visibility = 'visible';
                    symbols = zhuyinStr.slice(0, -1);
                } else {
                    symbols = zhuyinStr;
                }
            }
            symbolsDiv.innerHTML = symbols;
        }

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        document.getElementById('menu-toggle').onclick = toggleMenu;
        document.getElementById('overlay').onclick = toggleMenu;

        function speakWord() {
            if ('speechSynthesis' in window) {
                const word = lessons[currentLessonIdx].words[currentWordIdx].char;
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'zh-TW'; utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        document.getElementById('btn-prev').onclick = () => { if(currentWordIdx > 0) changeLesson(currentLessonIdx, currentWordIdx - 1); };
        document.getElementById('btn-next').onclick = () => { 
            if(currentWordIdx < lessons[currentLessonIdx].words.length - 1) changeLesson(currentLessonIdx, currentWordIdx + 1);
            else if(currentLessonIdx < lessons.length - 1 && confirm("å‰å¾€ä¸‹ä¸€èª²å—ï¼Ÿ")) changeLesson(currentLessonIdx + 1, 0);
        };
        document.getElementById('speak-button').onclick = speakWord;
        document.getElementById('animate-button').onclick = () => { speakWord(); writer.cancelQuiz(); writer.animateCharacter(); };
        document.getElementById('quiz-button').onclick = () => { writer.quiz({ onComplete: () => { speakWord(); setTimeout(() => alert('å¾ˆæ£’å–”ï¼å¯«å¾—å¾ˆæ¼‚äº®ï¼'), 300); }}); };

        // ========== Quiz Mode Functions ==========
        let quizMode = {
            active: false,
            words: [],
            currentIndex: 0,
            writer: null,
            correctCount: 0
        };

        // Open quiz modal
        document.getElementById('test-button').onclick = function() {
            document.getElementById('quiz-modal').classList.add('active');
        };

        // Cancel quiz
        document.getElementById('quiz-cancel-btn').onclick = function() {
            document.getElementById('quiz-modal').classList.remove('active');
        };

        // Start quiz
        document.getElementById('quiz-start-btn').onclick = function() {
            const startLesson = parseInt(document.getElementById('quiz-start-lesson').value) - 1;
            const endLesson = parseInt(document.getElementById('quiz-end-lesson').value) - 1;
            
            if (startLesson < 0 || endLesson >= lessons.length || startLesson > endLesson) {
                alert('èª²ç¨‹ç¯„åœä¸æ­£ç¢ºï¼è«‹è¼¸å…¥ 1~6 ä¹‹é–“çš„æ•¸å­—');
                return;
            }
            
            // Collect all words from selected lessons
            let allWords = [];
            for (let i = startLesson; i <= endLesson; i++) {
                allWords = allWords.concat(lessons[i].words.map(w => ({...w, lesson: i})));
            }
            
            // Randomly select 5 words
            quizMode.words = [];
            const shuffled = allWords.sort(() => Math.random() - 0.5);
            quizMode.words = shuffled.slice(0, Math.min(5, shuffled.length));
            quizMode.currentIndex = 0;
            quizMode.correctCount = 0;
            quizMode.active = true;
            
            document.getElementById('quiz-modal').classList.remove('active');
            document.getElementById('quiz-game-container').classList.add('active');
            
            debugLog('Quiz started with ' + quizMode.words.length + ' words');
            loadQuizWord();
        };

        // Exit quiz
        document.getElementById('quiz-exit-btn').onclick = function() {
            if (confirm('ç¢ºå®šè¦çµæŸæ¸¬é©—å—ï¼Ÿ')) {
                endQuiz();
            }
        };

        // Close success overlay
        document.getElementById('success-close-btn').onclick = function() {
            document.getElementById('quiz-success-overlay').classList.remove('active');
        };

        function endQuiz() {
            quizMode.active = false;
            document.getElementById('quiz-game-container').classList.remove('active');
            if (quizMode.writer) {
                quizMode.writer = null;
            }
        }

        function loadQuizWord() {
            if (quizMode.currentIndex >= quizMode.words.length) {
                showQuizSuccess();
                return;
            }
            
            const word = quizMode.words[quizMode.currentIndex];
            document.getElementById('quiz-game-progress').innerText = (quizMode.currentIndex + 1) + ' / ' + quizMode.words.length;
            
            renderQuizZhuyin(word.zhuyin);
            
            const boxSize = Math.min(window.innerWidth * 0.7, 280);
            document.getElementById('quiz-writer-div').innerHTML = '';
            document.getElementById('quiz-writer-div').style.width = boxSize + 'px';
            document.getElementById('quiz-writer-div').style.height = boxSize + 'px';
            
            debugLog('Quiz loading: ' + word.char + ' (' + word.zhuyin + ')');
            
            quizMode.writer = HanziWriter.create('quiz-writer-div', word.char, {
                width: boxSize,
                height: boxSize,
                padding: boxSize * 0.08,
                strokeColor: '#333333',
                radicalColor: '#e91e63',
                showOutline: false,
                showCharacter: false,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200,
                highlightOnVariation: true,
                drawingWidth: boxSize * 0.1,
                leniency: 2.0,
                charDataLoader: function(char, onComplete) {
                    const localUrl = './data/' + char + '.json';
                    fetch(localUrl)
                    .then(res => {
                        if (!res.ok) throw new Error("Local 404");
                        return res.json();
                    })
                    .then(data => {
                        debugLog('Quiz: Local data loaded for ' + char);
                        onComplete(data);
                    })
                    .catch(err => {
                        const cdnUrl = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + encodeURIComponent(char) + '.json';
                        fetch(cdnUrl)
                        .then(res => res.json())
                        .then(data => {
                            debugLog('Quiz: CDN data loaded for ' + char);
                            onComplete(data);
                        })
                        .catch(err2 => {
                            debugLog('Quiz: Failed to load ' + char);
                            onComplete(null);
                        });
                    });
                },
                onLoadCharDataSuccess: function() {
                    setTimeout(() => {
                        quizMode.writer.quiz({
                            onComplete: function(summaryData) {
                                debugLog('Quiz word completed: ' + word.char);
                                quizMode.correctCount++;
                                
                                if ('speechSynthesis' in window) {
                                    const utterance = new SpeechSynthesisUtterance(word.char);
                                    utterance.lang = 'zh-TW';
                                    utterance.rate = 0.8;
                                    window.speechSynthesis.speak(utterance);
                                }
                                
                                setTimeout(() => {
                                    quizMode.currentIndex++;
                                    loadQuizWord();
                                }, 1000);
                            }
                        });
                    }, 300);
                }
            });
        }

        function renderQuizZhuyin(zhuyinStr) {
            const lightToneDiv = document.getElementById('quiz-tone-light');
            const symbolsDiv = document.getElementById('quiz-zhuyin-symbols');
            const sideToneDiv = document.getElementById('quiz-tone-side');
            
            lightToneDiv.innerHTML = '';
            sideToneDiv.innerHTML = '';
            let symbols = '';
            
            if (zhuyinStr.includes('Ë™')) {
                lightToneDiv.innerHTML = 'Ë™';
                symbols = zhuyinStr.replace('Ë™', '');
            } else {
                const lastChar = zhuyinStr.slice(-1);
                if (['ËŠ', 'Ë‡', 'Ë‹'].includes(lastChar)) {
                    sideToneDiv.innerHTML = lastChar;
                    symbols = zhuyinStr.slice(0, -1);
                } else {
                    symbols = zhuyinStr;
                }
            }
            symbolsDiv.innerHTML = symbols;
        }

        function showQuizSuccess() {
            playSuccessSound();
            
            document.getElementById('success-subtext').innerHTML = 'å…¨éƒ¨ ' + quizMode.words.length + ' é¡Œéƒ½ç­”å°äº†ï¼';
            document.getElementById('quiz-success-overlay').classList.add('active');
            
            document.getElementById('quiz-game-container').classList.remove('active');
            quizMode.active = false;
        }

        function playSuccessSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                const notes = [523.25, 659.25, 783.99, 1046.50];
                const durations = [0.15, 0.15, 0.15, 0.4];
                let startTime = audioCtx.currentTime;
                
                notes.forEach((freq, i) => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.value = freq;
                    
                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + durations[i]);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + durations[i]);
                    
                    startTime += durations[i] * 0.8;
                });
                
                debugLog('Success sound played!');
            } catch (e) {
                debugLog('Audio not supported: ' + e.message);
            }
        }

        window.addEventListener('resize', () => { clearTimeout(window.resizeTimer); window.resizeTimer = setTimeout(loadCharacter, 200); });
        window.onload = function() { renderSidebar(); changeLesson(0, 0); debugLog('åº·è»’å°ä¸€åœ‹å­—ç³»çµ±è¼‰å…¥å®Œæˆï¼'); };
    </script>
</body>
</html>
